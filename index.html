<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø£Ø¯Ø§Ø© ÙØ­Øµ Ø§Ù„Ø´Ø¨ÙƒØ© ÙˆØ§Ù„Ù…Ù†Ø§ÙØ° Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #0f172a, #1e293b);
      color: #e0e0e0;
    }
    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #1e293b;
    }
    ::-webkit-scrollbar-thumb {
      background-color: #0ea5e9;
      border-radius: 4px;
    }
    /* Button focus */
    button:focus-visible {
      outline: 2px solid #22d3ee;
      outline-offset: 2px;
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6">

  <div class="max-w-4xl w-full bg-gradient-to-tr from-gray-900 via-gray-800 to-gray-900 rounded-3xl shadow-2xl p-8">
    <header class="mb-10 text-center">
      <h1 class="text-4xl font-extrabold text-cyan-400 drop-shadow-lg">Ø£Ø¯Ø§Ø© ÙØ­Øµ Ø§Ù„Ø´Ø¨ÙƒØ© ÙˆØ§Ù„Ù…Ù†Ø§ÙØ° Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h1>
      <p class="mt-2 text-gray-400 text-lg max-w-xl mx-auto">ÙØ­Øµ Ø§Ù„Ø´Ø¨ÙƒØ©ØŒ ÙƒØ´Ù Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©ØŒ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†Ø§ÙØ° Ø§Ù„Ù…ÙØªÙˆØ­Ø©ØŒ ÙˆÙ‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø³Ù‡ÙˆÙ„Ø©.</p>
    </header>

    <form id="scanForm" class="mb-8 flex flex-col md:flex-row gap-4 items-center justify-center">
      <input
        type="text"
        id="ipRange"
        placeholder="Ù…Ø«Ø§Ù„: 192.168.1.1/24"
        value="192.168.1.1/24"
        class="flex-grow bg-gray-700 text-white placeholder-gray-400 rounded-xl px-5 py-3 focus:outline-none focus:ring-4 focus:ring-cyan-500 shadow-md transition"
        required
      />
      <button
        type="submit"
        id="scanBtn"
        class="bg-cyan-600 hover:bg-cyan-700 active:bg-cyan-800 text-white font-semibold rounded-xl px-8 py-3 shadow-lg transform transition hover:scale-105 focus:outline-none focus:ring-4 focus:ring-cyan-400"
      >
        ğŸ” ÙØ­Øµ Ø§Ù„Ø´Ø¨ÙƒØ©
      </button>
    </form>

    <p id="loading" class="text-center text-cyan-400 mb-6 hidden">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­ØµØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</p>

    <div id="resultSection" class="overflow-x-auto max-h-[450px] rounded-xl shadow-inner bg-gray-900 p-4 hidden">
      <table class="min-w-full text-right border-collapse">
        <thead>
          <tr class="bg-gray-700 text-gray-300 sticky top-0">
            <th class="px-6 py-3 border border-gray-600">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù€ IP</th>
            <th class="px-6 py-3 border border-gray-600">Ø§Ù„Ø¨ÙˆØ±ØªØ§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©</th>
            <th class="px-6 py-3 border border-gray-600">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="devicesBody" class="divide-y divide-gray-700"></tbody>
      </table>
    </div>
  </div>

<script>
  const backendUrl = window.location.origin;
  const scanForm = document.getElementById('scanForm');
  const ipRangeInput = document.getElementById('ipRange');
  const loadingText = document.getElementById('loading');
  const resultSection = document.getElementById('resultSection');
  const devicesBody = document.getElementById('devicesBody');

  scanForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const ipRange = ipRangeInput.value.trim();
    if (!ipRange) {
      alert('Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ Ù†Ø·Ø§Ù‚ IP ØµØ­ÙŠØ­');
      return;
    }

    devicesBody.innerHTML = '';
    resultSection.classList.add('hidden');
    loadingText.classList.remove('hidden');

    try {
      const scanRes = await fetch(`${backendUrl}/scan`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ipRange }),
      });
      const scanData = await scanRes.json();
      if (scanData.error) {
        alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙØ­Øµ: ' + scanData.error);
        loadingText.classList.add('hidden');
        return;
      }

      const devices = scanData.devices;
      if (!devices.length) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø¬Ù‡Ø²Ø© ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©.');
        loadingText.classList.add('hidden');
        return;
      }

      for (const device of devices) {
        const row = document.createElement('tr');
        row.classList.add('hover:bg-gray-700', 'transition-colors');

        // Ù…Ø¤Ù‚ØªÙ‹Ø§ Ù†Ø¹Ø±Ø¶ "Ø¬Ø§Ø± ÙØ­Øµ Ø§Ù„Ø¨ÙˆØ±ØªØ§Øª"
        row.innerHTML = `
          <td class="border border-gray-600 px-6 py-3">${device.ip}</td>
          <td class="border border-gray-600 px-6 py-3 text-cyan-400 font-mono">Ø¬Ø§Ø±Ù Ø§Ù„ÙØ­Øµ...</td>
          <td class="border border-gray-600 px-6 py-3 text-center">
            <button disabled
              class="bg-red-600 cursor-not-allowed text-white px-4 py-1 rounded-xl select-none"
            >Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„</button>
          </td>
        `;
        devicesBody.appendChild(row);

        // Ù†Ø¨Ø¯Ø£ ÙØ­Øµ Ø§Ù„Ø¨ÙˆØ±ØªØ§Øª
        fetch(`${backendUrl}/scanPorts`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ip: device.ip }),
        })
          .then(res => res.json())
          .then(portsData => {
            let openPorts = 'Ù„Ø§ Ø¨ÙˆØ±ØªØ§Øª Ù…ÙØªÙˆØ­Ø©';
            if (portsData.error) {
              openPorts = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙØ­Øµ';
            } else if (portsData.ports && portsData.ports.length) {
              const openPortNumbers = portsData.ports
                .filter(p => p.state === 'open')
                .map(p => p.port)
                .join(', ');
              openPorts = openPortNumbers || openPorts;
            }

            row.cells[1].textContent = openPorts;

            // Ø²Ø± Ø§Ù„Ù‚Ø·Ø¹ ÙŠØµØ¨Ø­ Ù…ØªØ§Ø­
            row.cells[2].innerHTML = `
              <button
                class="bg-red-600 hover:bg-red-700 active:bg-red-800 text-white px-4 py-1 rounded-xl font-semibold transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-400"
                onclick="blockDevice('${device.ip}', this)">Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„
              </button>
            `;
          })
          .catch(() => {
            row.cells[1].textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙØ­Øµ';
            row.cells[2].textContent = '-';
          });
      }

      resultSection.classList.remove('hidden');
    } catch (err) {
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙØ­Øµ: ' + err.message);
    } finally {
      loadingText.classList.add('hidden');
    }
  });

  async function blockDevice(ip, btn) {
    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² ${ip}ØŸ`)) return;
    btn.disabled = true;
    btn.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªÙ†ÙÙŠØ°...';
    try {
      const res = await fetch(`${backendUrl}/block`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ip }),
      });
      const data = await res.json();
      alert(data.message || 'ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');
    } catch (err) {
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„: ' + err.message);
    } finally {
      btn.textContent = 'Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„';
      btn.disabled = false;
    }
  }
</script>

</body>
</html>
